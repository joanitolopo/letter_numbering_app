<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambah Dokumen</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Tambah Dokumen</h1>
        <a href="{{ url_for('index') }}" class="btn">Kembali</a>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" id="addForm">
            <div class="form-group">
                <label for="start_date">Tanggal Mulai:</label>
                <input type="date" id="start_date" name="start_date" required>
            </div>
            <div class="form-group">
                <label for="end_date">Tanggal Selesai (opsional):</label>
                <input type="date" id="end_date" name="end_date">
            </div>

            <div class="form-group">
                <label>Nama Petugas (maksimal 6):</label>
                <div id="officerFields">
                    <div class="officer-field">
                        <select name="officer_names_1" class="officer-select" required>
                            <option value="">Pilih Petugas</option>
                            {% for officer in officers %}
                                <option value="{{ officer }}">{{ officer }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <button type="button" class="btn btn-add-officer" onclick="addOfficerField()">Tambah Petugas</button>
            </div>

            <div class="form-group">
                <label for="activity">Kegiatan:</label>
                <input type="text" id="activity" name="activity" required>
            </div>

            <button type="submit" class="btn">Tambah Dokumen</button>
        </form>
    </div>

    <script>
        const officersFromServer = {{ officers|tojson|safe }};
        let officerCount = 1;
        const maxOfficers = 6;

        function addOfficerField() {
            if (officerCount >= maxOfficers) {
                alert('Maksimal 6 petugas dapat dipilih!');
                return;
            }

            officerCount++;
            const officerFields = document.getElementById('officerFields');
            const newField = document.createElement('div');
            newField.className = 'officer-field';

            const select = document.createElement('select');
            select.name = `officer_names_${officerCount}`;
            select.className = 'officer-select';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'Pilih Petugas';
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            officersFromServer.forEach(officer => {
                const option = document.createElement('option');
                option.value = officer;
                option.text = officer;
                select.appendChild(option);
            });

            newField.appendChild(select);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-remove-officer';
            removeBtn.innerText = 'Hapus';
            removeBtn.onclick = function () { removeOfficerField(removeBtn); };
            newField.appendChild(removeBtn);

            officerFields.appendChild(newField);
            updateOfficerOptions();

            if (officerCount >= maxOfficers) {
                const addButton = document.querySelector('.btn-add-officer');
                if (addButton) addButton.style.display = 'none';
            }
        }

        function removeOfficerField(button) {
            if (officerCount > 1) {
                button.parentElement.remove();
                officerCount--;
                updateOfficerOptions();

                const addButton = document.querySelector('.btn-add-officer');
                if (addButton) addButton.style.display = 'block';
            }
        }

        function updateOfficerOptions() {
            const selects = document.querySelectorAll('.officer-select');
            const selectedValues = Array.from(selects)
                .map(s => s.value)
                .filter(v => v !== '');

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.text = 'Pilih Petugas';
                if (!currentValue) defaultOption.selected = true;
                select.appendChild(defaultOption);

                officersFromServer.forEach(officer => {
                    if (!selectedValues.includes(officer) || officer === currentValue) {
                        const option = document.createElement('option');
                        option.value = officer;
                        option.text = officer;
                        if (officer === currentValue) option.selected = true;
                        select.appendChild(option);
                    }
                });
            });
        }

        document.addEventListener('change', (event) => {
            if (event.target.classList.contains('officer-select')) {
                updateOfficerOptions();
            }
        });

        // Validasi rentang tanggal di frontend
        document.getElementById('addForm').addEventListener('submit', function (event) {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;

            if (endDate && startDate > endDate) {
                alert('Tanggal selesai harus sama atau setelah tanggal mulai!');
                event.preventDefault();
            }
        });
    </script>
</body>
</html>